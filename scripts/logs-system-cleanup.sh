#!/bin/bash

# æ—¥èªŒç³»çµ±æ¨™æº–åŒ–é—œé–‰èˆ‡é©—è­‰è…³æœ¬
# ç¢ºä¿ç«¯å£ 5001 æ­£ç¢ºé‡‹æ”¾ï¼Œé¿å…å½±éŸ¿å¾ŒçºŒåŸ·è¡Œ

set -e

echo "ğŸ”„ é–‹å§‹æ—¥èªŒç³»çµ±æ¸…ç†æµç¨‹..."

# 1. åœæ­¢æ‰€æœ‰ç›¸é—œé€²ç¨‹
echo "ğŸ“ æ­¥é©Ÿ 1: åœæ­¢æ—¥èªŒæœå‹™å™¨é€²ç¨‹"
if pkill -f "server/server.js" 2>/dev/null; then
    echo "âœ… æ—¥èªŒæœå‹™å™¨é€²ç¨‹å·²åœæ­¢"
else
    echo "â„¹ï¸  ç„¡é‹è¡Œä¸­çš„æ—¥èªŒæœå‹™å™¨é€²ç¨‹"
fi

# 2. å¼·åˆ¶é‡‹æ”¾ç«¯å£ (å¦‚æœéœ€è¦)
echo "ğŸ“ æ­¥é©Ÿ 2: æª¢æŸ¥ä¸¦é‡‹æ”¾ç«¯å£ 5001"
if lsof -i :5001 >/dev/null 2>&1; then
    echo "âš ï¸  æª¢æ¸¬åˆ°ç«¯å£ 5001 ä»è¢«ä½”ç”¨ï¼Œå¼·åˆ¶é‡‹æ”¾..."
    pkill -9 -f ":5001" 2>/dev/null || true
    sleep 2
fi

# 3. é©—è­‰ç«¯å£å®Œå…¨é‡‹æ”¾
echo "ğŸ“ æ­¥é©Ÿ 3: é©—è­‰ç«¯å£é‡‹æ”¾ç‹€æ…‹"
if lsof -i :5001 >/dev/null 2>&1; then
    echo "âŒ ç«¯å£ 5001 ä»è¢«ä½”ç”¨ï¼"
    lsof -i :5001
    exit 1
else
    echo "âœ… ç«¯å£ 5001 å·²æ­£ç¢ºé‡‹æ”¾"
fi

# 4. é©—è­‰é€²ç¨‹å®Œå…¨æ¸…ç†
echo "ğŸ“ æ­¥é©Ÿ 4: é©—è­‰é€²ç¨‹æ¸…ç†ç‹€æ…‹"
if ps aux | grep "server/server.js" | grep -v grep >/dev/null 2>&1; then
    echo "âŒ ä»æœ‰æ—¥èªŒæœå‹™å™¨é€²ç¨‹åœ¨é‹è¡Œï¼"
    ps aux | grep "server/server.js" | grep -v grep
    exit 1
else
    echo "âœ… æ—¥èªŒæœå‹™å™¨é€²ç¨‹å·²å®Œå…¨æ¸…ç†"
fi

# 5. æ¸…ç†è‡¨æ™‚æ–‡ä»¶
echo "ğŸ“ æ­¥é©Ÿ 5: æ¸…ç†è‡¨æ™‚æ–‡ä»¶"
rm -f /tmp/logs-server.log
echo "âœ… è‡¨æ™‚æ–‡ä»¶å·²æ¸…ç†"

echo "ğŸ‰ æ—¥èªŒç³»çµ±æ¸…ç†å®Œæˆï¼ç«¯å£ 5001 å¯ä¾›ä¸‹æ¬¡ä½¿ç”¨"
echo ""
echo "ä½¿ç”¨æ–¹æ³•ï¼š"
echo "  ./scripts/logs-system-cleanup.sh         # åŸ·è¡Œå®Œæ•´æ¸…ç†"
echo "  ./scripts/logs-system-cleanup.sh --quick # å¿«é€Ÿæ¸…ç† (ä¸ç­‰å¾…)"
echo ""
